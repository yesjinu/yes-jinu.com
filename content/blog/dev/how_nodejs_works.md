---
title: How Node.js works
date: 2021-06-29 23:06:55 +0900
category: dev
thumbnail: { thumbnailSrc }
draft: false
---

## Node.js란?

node.js는 자바스크립트 런타임 환경으로, 브라우저 바깥에서 자바스크립트의 코드를 실행할 수 있게 하는 오픈소스 프로젝트입니다. 실제로 node.js 내부에서 사용하는 자바스크립트 엔진 V8은 크롬에서 사용하는 엔진과 동일하죠. node.js는 다음과 같은 2가지 이유로 매우 큰 인기를 끌고 있습니다.

(1) 비동기, 이벤트 드리븐 I/O 방식으로 설계되어 있어 웹과 데이터를 주고 받을 일이 많은 data-intensive 어플리케이션에 특화되어 있다는 점

(2) 자체 패키지 매니저인 npm을 제공해 다른 사람이 만든 모듈을 쉽게 가져다 쓸 수 있다는 점

사용자는 자바스크립트로 코드를 작성하고, 작성한 `.js` 파일을 `node`로 실행하면 마법처럼 코드가 실행됩니다. 
ex) `node hello.js` : hello.js 파일을 실행

프로젝트에 필요한 기능이 있으면, 직접 코드를 구현할 필요없이 패키지 매니저인 npm을 통해 원하는 모듈을 내려받고 import해서 사용할 수 있습니다. 
ex) `npm install mysql` : mysql 모듈을 다운로드하기

## Inside Node.js

이번 포스팅에서는 node.js의 내부 구조를 살펴보고, 실행 플로우를 분석해보려 합니다. 많은 경우 라이브러리가 제공하는 interface를 사용할 수 있는 정도로 충분하지만, 내부 구조를 이해하면 디자인 선택의 기로에서 더 좋은 선택을 할 수 있습니다. 

노드의 가장 큰 2가지 특징은 다음과 같습니다.
1. 브라우저 바깥의 자바스크립트 실행 환경
2. 이벤트 루프 모델

따라서 다음 두 가지 질문에 대한 해답을 찾아가는 과정을 통해 우리는 노드를 더 잘 이해할 수 있게 될 겁니다.
1. '자바스크립트로 작성된 코드가 어떻게 실행되는가?'
2. '노드는 어떻게 비동기적으로 동작하는가?'

[Source code link](https://github.com/nodejs/node)

### 1. 자바스크립트로 작성된 코드가 어떻게 실행되는가?

- 노드 소스코드의 lib/ 디렉토리에는 프로젝트에 사용하는 JS 함수, 모듈들의 definition이 저장되어 있습니다. 
- 예시로 lib/fs.js::readFile() 함수를 살펴볼 예정입니다. 이 함수는 V8이나 JS가 제공하는 함수가 아닌, node에서 구현된 함수이고, local OS에 binding 되어 있기 때문에 분석하기에 좋을 것이라고 생각했습니다.
- high-level에서 보았을 때, lib/ 디렉토리의 fs.readFile()은 JS로만 구현이 되어있고, 함수의 마지막 단에서 C++ 코드와 연결하는 binding 함수를 호출하는 것을 확인할 수 있습니다. 
- binding함수(객체?)를 호출한 fs.js 파일은 node_file.cc의 namespace fs와 연결됩니다. 이 namespace 안에는 C++ 구현된 file system 코드인 FSReqCallBack이 있습니다. 

### 2. 노드는 어떻게 비동기적으로 코드를 실행하는가?
- 노드를 시작하면 자동으로 이벤트 루프가 실행됩니다. 이벤트 루프는 함수 호출이 쌓이는 콜 스택(LIFO)과 콜백 함수가 쌓이는 콜백 큐(FIFO)를 모니터링합니다.
- 이벤트 루프는 콜 스택에 쌓인 함수를 차례대로 execute합니다. 인자로 callback을 넘긴 함수를 실행하게 되면(ex - setTimeout(console.log('Hi')), 5), 함수는 실행된 이후 콜 스택에서 지워지고, callback 함수는 다른 곳(어디?)에서 실행됩니다. callback이 실행완료된 이후에는 콜백 큐로 들어가게 됩니다. 
- 이벤트 루프는 콜 스택에 더이상 실행할 함수가 남아있지 않을 때, 콜백 큐를 pop해서 나온 값을 콜 스택에 push하고 실행합니다.
- 콜 스택과 콜백 큐에 아무것도 남아있지 않으면, process.exit 합니다.

